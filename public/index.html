<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>FA Viewer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1117;--card:#181c27;--modal:#1c2030;--border:#272d3f;--border-h:#424d6b;--text:#dde3f4;--text2:#9aa3bc;--muted:#505870;--poster:#161b28;--btn:#1e2336;--shadow:rgba(0,0,0,.5);--shadowh:rgba(0,0,0,.7);--header:rgba(15,17,23,.97);--accent:#f5a623}
    .light{--bg:#f2f4fb;--card:#fff;--modal:#fff;--border:#e1e6f5;--border-h:#9aa8cc;--text:#18202e;--text2:#4a5568;--muted:#8896b0;--poster:#e1e6f5;--btn:#e8ecf7;--shadow:rgba(0,0,0,.07);--shadowh:rgba(0,0,0,.18);--header:rgba(242,244,251,.97);--accent:#d4891a}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;min-height:100vh;-webkit-text-size-adjust:100%}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
    ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

    header{position:sticky;top:0;z-index:200;background:var(--header);backdrop-filter:blur(18px);border-bottom:1px solid var(--border)}
    .hrow{max-width:1440px;margin:0 auto;padding:0 12px;min-height:56px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding-top:6px;padding-bottom:6px}
    .logo{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;flex-shrink:0;letter-spacing:-.02em;line-height:1.1}
    .logo em{color:var(--accent);font-style:normal}
    .logo small{display:block;font-size:9px;font-family:'Inter',sans-serif;font-weight:400;color:var(--muted);margin-top:2px}

    /* filtros */
    .fgroup{display:flex;gap:3px;background:var(--btn);border-radius:8px;padding:3px;flex-shrink:0}
    .fbtn{background:transparent;border:none;color:var(--muted);padding:5px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:700;font-family:inherit;transition:all .15s}
    .fbtn.on{background:var(--accent);color:#000}

    /* bÃºsqueda */
    .search-wrap{position:relative;min-width:80px;max-width:200px;flex:1}
    .search-wrap svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);opacity:.35;pointer-events:none}
    #search-input{width:100%;background:var(--btn);border:1px solid var(--border);color:var(--text);padding:6px 10px 6px 30px;border-radius:8px;font-size:12px;font-family:inherit;outline:none;transition:border .15s}
    #search-input:focus{border-color:var(--accent)}
    #search-input::placeholder{color:var(--muted)}

    /* filtro nota */
    .rating-filter{display:flex;align-items:center;gap:6px;background:var(--btn);border:1px solid var(--border);border-radius:8px;padding:4px 10px;flex-shrink:0}
    .rating-filter label{font-size:11px;color:var(--muted);white-space:nowrap}
    .rating-filter select{background:transparent;border:none;color:var(--text);font-size:12px;font-family:inherit;font-weight:700;outline:none;cursor:pointer;padding:0}
    .rating-filter select option{background:var(--card)}

    .spacer{flex:1;min-width:4px}
    .count{font-size:11px;color:var(--muted);flex-shrink:0;white-space:nowrap}
    .count .dc{color:#ef4444}
    .ibtn{background:var(--btn);border:1px solid var(--border);color:var(--text);padding:7px 11px;border-radius:9px;cursor:pointer;font-size:12px;font-weight:600;font-family:inherit;display:flex;align-items:center;gap:5px;flex-shrink:0;transition:background .15s;white-space:nowrap}
    .ibtn:hover{background:var(--border)}
    .ibtn:disabled{opacity:.45;cursor:not-allowed}
    .ibtn.on{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35);color:#f87171}
    .spin{display:inline-block;animation:spin .8s linear infinite}
    .pbar{height:3px;background:var(--border)}
    .pfill{height:100%;background:var(--accent);transition:width .4s ease}

    main{max-width:1440px;margin:0 auto;padding:16px 12px 60px}

    /* empty state */
    .empty-state{text-align:center;padding:80px 20px;animation:fadeUp .4s ease}
    .empty-state .icon{font-size:52px;margin-bottom:16px}
    .empty-state h2{font-family:'Syne',sans-serif;font-size:20px;margin-bottom:8px}
    .empty-state p{color:var(--muted);font-size:14px;line-height:1.7;max-width:360px;margin:0 auto 24px}
    .cta-btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#000;border:none;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer}
    .cta-btn:disabled{opacity:.5;cursor:not-allowed}

    /* status / error */
    .sbox{display:flex;align-items:center;gap:10px;padding:10px 14px;margin-bottom:14px;background:var(--btn);border-radius:10px;border:1px solid var(--border);animation:fadeUp .3s ease}
    .spi{width:14px;height:14px;border-radius:50%;border:2px solid var(--border);border-top-color:var(--accent);animation:spin .8s linear infinite;flex-shrink:0}
    .stxt{font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
    .sright{font-size:11px;color:var(--muted);flex-shrink:0}
    .ebox{padding:18px 20px;margin-bottom:14px;background:rgba(127,29,29,.18);border-radius:12px;border:1px solid rgba(239,68,68,.25)}
    .etitle{font-weight:700;color:#f87171;margin-bottom:6px}
    .emsg{font-size:13px;color:#fca5a5;line-height:1.6}
    .rbtn{margin-top:12px;background:#7f1d1d;color:#fff;border:none;padding:8px 18px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;font-family:inherit}

    /* warning (amarillo) */
    .wbox{padding:14px 18px;margin-bottom:14px;background:rgba(245,166,35,.1);border-radius:12px;border:1px solid rgba(245,166,35,.3);font-size:13px;color:#fcd34d;line-height:1.6}

    /* grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(128px,1fr));gap:12px}
    @media(min-width:600px){.grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px}}

    /* card */
    .card{background:var(--card);border-radius:12px;overflow:hidden;cursor:pointer;border:1px solid var(--border);transition:transform .2s cubic-bezier(.16,1,.3,1),box-shadow .2s,border-color .2s,opacity .2s;box-shadow:0 2px 8px var(--shadow);animation:fadeUp .4s ease both;position:relative}
    .card:hover{transform:translateY(-5px) scale(1.015);box-shadow:0 18px 40px var(--shadowh);border-color:var(--border-h)}
    .card.deleted{opacity:.35;border-color:rgba(239,68,68,.35)}
    .pwrap{position:relative;padding-top:148%;background:var(--poster);overflow:hidden}
    .pwrap img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transition:transform .35s ease}
    .card:hover .pwrap img{transform:scale(1.06)}
    .pph{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:32px;color:var(--muted)}
    .grad{position:absolute;bottom:0;left:0;right:0;height:55%;background:linear-gradient(to top,rgba(0,0,0,.85),transparent);pointer-events:none}
    .tbadge{position:absolute;top:7px;left:7px;color:#fff;font-size:8px;font-weight:800;padding:2px 6px;border-radius:20px;letter-spacing:.1em;text-transform:uppercase;backdrop-filter:blur(4px)}
    .tmovie{background:rgba(185,28,28,.88)}.tseries{background:rgba(109,40,217,.88)}
    .rbadge{position:absolute;bottom:30px;left:8px;color:#fbbf24;font-size:12px;font-weight:800;text-shadow:0 1px 4px rgba(0,0,0,.9);pointer-events:none}
    .delbtn{position:absolute;top:7px;right:7px;z-index:10;width:28px;height:28px;background:rgba(0,0,0,.55);border:1.5px solid rgba(255,255,255,.2);backdrop-filter:blur(4px);border-radius:50%;color:#fff;font-size:14px;font-weight:900;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;opacity:0}
    @media(hover:hover){.card:hover .delbtn{opacity:1}}
    @media(hover:none){.delbtn{opacity:.85}}
    .delbtn.on{opacity:1!important;background:rgba(239,68,68,.9);border-color:#ef4444}
    .delover{position:absolute;inset:0;background:rgba(239,68,68,.1);display:flex;align-items:center;justify-content:center;pointer-events:none}
    .dellabel{background:rgba(239,68,68,.9);color:#fff;font-weight:900;font-size:9px;letter-spacing:.15em;padding:4px 10px;border-radius:4px;transform:rotate(-8deg);text-transform:uppercase}
    .cinfo{padding:8px 10px 10px}
    .ctitle{font-size:12px;font-weight:600;color:var(--text);line-height:1.3;font-family:'Syne',sans-serif;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-bottom:2px}
    .cmeta{font-size:10px;color:var(--muted)}

    .cmsg{text-align:center;padding:80px 20px}
    .bspin{width:48px;height:48px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--accent);animation:spin .9s linear infinite;margin:0 auto 16px}
    .cmsg p{color:var(--muted);font-size:14px}

    /* modal */
    .overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);display:flex;align-items:flex-end;justify-content:center;animation:fadeUp .2s ease}
    @media(min-width:600px){.overlay{align-items:center;padding:20px}}
    .modal{background:var(--modal);border-radius:20px 20px 0 0;width:100%;max-height:92vh;overflow-y:auto;border:1px solid var(--border);animation:slideUp .28s cubic-bezier(.16,1,.3,1);position:relative}
    @media(min-width:600px){.modal{border-radius:20px;max-width:680px}}
    .mhandle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 0}
    @media(min-width:600px){.mhandle{display:none}}
    .xbtn{position:absolute;top:12px;right:12px;z-index:20;background:var(--btn);border:1px solid var(--border);color:var(--text);width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;font-family:inherit}
    .minner{display:flex;flex-direction:column}
    @media(min-width:500px){.minner{flex-direction:row}}
    .mposter{width:100%;height:200px;flex-shrink:0;overflow:hidden;background:var(--poster)}
    @media(min-width:500px){.mposter{width:180px;height:auto;min-height:260px}}
    .mposter img{width:100%;height:100%;object-fit:cover;object-position:top;display:block}
    .mpostph{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:48px;color:var(--muted)}
    .minfo{flex:1;padding:16px 50px 22px 16px;min-width:0}
    @media(min-width:500px){.minfo{padding:20px 52px 24px 20px}}
    .mbadges{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px}
    .mbadge{font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;letter-spacing:.08em;text-transform:uppercase}
    .mbseries{background:rgba(124,58,237,.2);color:#a78bfa;border:1px solid rgba(124,58,237,.3)}
    .mbmovie{background:rgba(185,28,28,.2);color:#f87171;border:1px solid rgba(185,28,28,.3)}
    .mbrating{background:rgba(245,166,35,.12);color:var(--accent);border:1px solid rgba(245,166,35,.25)}
    .mtitle{font-size:18px;line-height:1.25;font-family:'Syne',sans-serif;font-weight:800;color:var(--text);margin-bottom:6px}
    @media(min-width:500px){.mtitle{font-size:20px}}
    .mmeta{font-size:13px;color:var(--muted);margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap}
    .msynopsis{line-height:1.75;color:var(--text2);font-size:13px;margin-bottom:18px}
    .msynnone{color:var(--muted);font-size:13px;font-style:italic;margin-bottom:18px}
    .mactions{display:flex;align-items:center;flex-wrap:wrap;gap:8px}
    .falink{display:inline-flex;align-items:center;gap:6px;background:var(--accent);color:#000;padding:10px 18px;border-radius:10px;text-decoration:none;font-weight:700;font-size:13px}
    .falink:hover{opacity:.85}
    .mdelbtn{display:inline-flex;align-items:center;gap:5px;background:transparent;border:1px solid var(--border);color:var(--muted);padding:10px 13px;border-radius:10px;font-weight:700;font-size:12px;font-family:inherit;cursor:pointer;transition:all .15s}
    .mdelbtn.on{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#f87171}
    .tmdb-note{font-size:10px;color:var(--muted);margin-top:12px;opacity:.55}

    /* debug panel */
    #dbg{position:fixed;bottom:12px;left:12px;right:12px;background:#080b10;border:1px solid #2a3;border-radius:10px;padding:10px 12px;font:11px/1.5 monospace;color:#4f9;z-index:9999;max-height:150px;overflow-y:auto}
  </style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="logo"><em>FA</em> Viewer<small id="last-update"></small></div>

    <!-- tipo -->
    <div class="fgroup">
      <button class="fbtn on" data-f="all"    onclick="setFilter('all')">Todo</button>
      <button class="fbtn"    data-f="movies" onclick="setFilter('movies')">ğŸ¬</button>
      <button class="fbtn"    data-f="series" onclick="setFilter('series')">ğŸ“º</button>
    </div>

    <!-- bÃºsqueda -->
    <div class="search-wrap">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input id="search-input" type="search" placeholder="Buscarâ€¦" oninput="onSearch(this.value)" autocomplete="off"/>
    </div>

    <!-- filtro por nota -->
    <div class="rating-filter">
      <label for="min-rating">â˜… â‰¥</label>
      <select id="min-rating" onchange="onRatingFilter(this.value)">
        <option value="0">Todas</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="6.5">6.5</option>
        <option value="7">7</option>
        <option value="7.5">7.5</option>
        <option value="8">8</option>
        <option value="8.5">8.5</option>
        <option value="9">9</option>
      </select>
    </div>

    <!-- filtro por gÃ©nero -->
    <div class="rating-filter">
      <label for="genre-filter">ğŸ­</label>
      <select id="genre-filter" onchange="onGenreFilter(this.value)">
        <option value="">GÃ©nero</option>
      </select>
    </div>

    <div class="spacer"></div>
    <div class="count" id="count-lbl"></div>

    <button class="ibtn" id="only-del-btn" onclick="toggleOnlyDel()" title="Solo marcados para borrar">ğŸ—‘</button>
    <button class="ibtn" id="hide-del-btn" onclick="toggleHideDel()" title="Ocultar marcados">ğŸ‘</button>
    <button class="ibtn" id="refresh-btn"  onclick="doRefresh()">
      <span id="refresh-ic">â†º</span><span class="hxs"> Actualizar</span>
    </button>
    <button class="ibtn" onclick="toggleDark()"><span id="dark-ic">â˜€</span></button>
  </div>
  <div class="pbar"><div class="pfill" id="pfill" style="width:0%"></div></div>
</header>

<main>
  <div id="warn-area"></div>
  <div id="status-area"></div>
  <div id="grid-wrap"></div>
</main>

<div class="overlay" id="overlay" style="display:none">
  <div class="modal">
    <div class="mhandle"></div>
    <button class="xbtn" id="xbtn">âœ•</button>
    <div class="minner">
      <div class="mposter" id="mposter"></div>
      <div class="minfo">
        <div class="mbadges" id="mbadges"></div>
        <h2 class="mtitle" id="mtitle"></h2>
        <div class="mmeta" id="mmeta"></div>
        <div id="mgenres" style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px"></div>
        <p id="msynopsis" class="msynopsis"></p>
        <div class="mactions">
          <a class="falink" id="falink" href="#" target="_blank" rel="noopener">Ver en FilmAffinity â†—</a>
          <button class="mdelbtn" id="mdelbtn" onclick="toggleDelModal()">âœ• Marcar</button>
        </div>
        <p class="tmdb-note" id="tmdb-note"></p>
      </div>
    </div>
  </div>
</div>

<style>@media(max-width:480px){.hxs{display:none}}</style>

<script>
// â”€â”€ Constantes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_URL = "https://www.filmaffinity.com/es/userlist.php?user_id=629775&list_id=1013";
const API = window.FA_API_URL || "";

// â”€â”€ Estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allFilms   = [];
let deletedIds = new Set();
let filter     = "all";
let searchQ    = "";
let minRating  = 0;
let genreFilter = "";
let hideDel    = false;
let onlyDel    = false;
let dark       = true;
let refreshing = false;
let modalId    = null;

// â”€â”€ URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getListUrl() {
  try {
    const raw = new URLSearchParams(location.search).get("url");
    if (!raw) return DEFAULT_URL;
    // Decodificar: URLSearchParams ya decodifica %2F etc., pero hay que restaurar
    // los caracteres base64 que pudieran haberse alterado
    const b64 = raw.replace(/ /g, "+"); // URLSearchParams convierte + en espacio
    const decoded = atob(b64);
    if (decoded.includes("filmaffinity.com")) return decoded;
  } catch(e) { console.error("getListUrl error:", e); }
  return DEFAULT_URL;
}
function listKey()    { return "fa_" + btoa(getListUrl()).replace(/[^a-z0-9]/gi,"").slice(0,20); }
function listUrlB64() { return btoa(getListUrl()); }
const urlParam = () => `url=${encodeURIComponent(listUrlB64())}`;

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setProgress(p) { document.getElementById("pfill").style.width = p + "%"; }
function setStatus(msg, done, total) {
  const el = document.getElementById("status-area");
  if (!msg) { el.innerHTML = ""; setProgress(0); return; }
  setProgress(total > 0 ? done/total*100 : 15);
  el.innerHTML = `<div class="sbox"><div class="spi"></div><span class="stxt">${msg}</span>${total > 0 ? `<span class="sright">${done}/${total}</span>` : ""}</div>`;
}
function setError(msg) {
  setProgress(0);
  document.getElementById("status-area").innerHTML = msg
    ? `<div class="ebox"><div class="etitle">âš  Error</div><div class="emsg">${msg}</div><button class="rbtn" onclick="doRefresh()">Reintentar</button></div>`
    : "";
}
function setWarn(msg) {
  document.getElementById("warn-area").innerHTML = msg
    ? `<div class="wbox">âš  ${msg}</div>` : "";
}
function showLastUpdate(ts, cached) {
  if (!ts) return;
  const d = new Date(ts);
  document.getElementById("last-update").textContent =
    (cached ? "CachÃ© " : "") +
    d.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit"}) + " " +
    d.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});
}
function updateCount() {
  const v = visible();
  document.getElementById("count-lbl").innerHTML =
    `${v.length}/${allFilms.length}` + (deletedIds.size > 0 ? ` <span class="dc">Â·${deletedIds.size}âœ•</span>` : "");
}
function setBusy(b) {
  document.getElementById("refresh-btn").disabled = b;
  document.getElementById("refresh-ic").className = b ? "spin" : "";
}

// â”€â”€ Filtros â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function visible() {
  const q = searchQ.toLowerCase().trim();
  return allFilms.filter(f => {
    const id = f.id || f.title;
    if (onlyDel && !deletedIds.has(id)) return false;
    if (hideDel &&  deletedIds.has(id)) return false;
    if (filter === "movies" && f.type === "series") return false;
    if (filter === "series" && f.type !== "series") return false;
    if (minRating > 0 && (f.rating == null || f.rating < minRating)) return false;
    if (genreFilter && !(f.genres || []).includes(genreFilter)) return false;
    if (q && !(f.title||"").toLowerCase().includes(q)) return false;
    return true;
  });
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  // Cargar marcas desde servidor
  const marks = await fetch(`${API}/api/marks/${listKey()}`).then(r => r.json()).catch(() => ({ marks: [] }));
  deletedIds = new Set(marks.marks || []);

  setStatus("Cargandoâ€¦");
  try {
    const r = await fetch(`${API}/api/list?${urlParam()}`);
    const d = await r.json();
    if (!d.empty && d.films && d.films.length > 0) {
      allFilms = d.films;
      showLastUpdate(d.ts, d.cached);
      setStatus(null);
      populateGenres();
      renderGrid();
      updateCount();
      return;
    }
  } catch(e) {
    setStatus(null);
    setError("No se pudo conectar con el servidor: " + e.message);
    return;
  }

  // Sin datos en servidor â€” mostrar pantalla de bienvenida
  setStatus(null);
  showEmptyState();
}

// â”€â”€ Pantalla vacÃ­a â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showEmptyState() {
  document.getElementById("grid-wrap").innerHTML = `
    <div class="empty-state">
      <div class="icon">ğŸ¬</div>
      <h2>Lista vacÃ­a</h2>
      <p>No hay datos descargados todavÃ­a.<br>Pulsa el botÃ³n para cargar la lista desde FilmAffinity.</p>
      <button class="cta-btn" id="cta-btn" onclick="doRefresh()">
        <span id="cta-ic">â†º</span> Descargar lista ahora
      </button>
    </div>`;
}

// â”€â”€ Refresco â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doRefresh() {
  if (refreshing) return;
  refreshing = true;
  setError(null); setWarn(null); setBusy(true);

  const cta = document.getElementById("cta-btn");
  if (cta) { cta.disabled = true; document.getElementById("cta-ic").className = "spin"; }

  dbg("â†’ POST /api/refresh");
  setStatus("Iniciando descarga desde FilmAffinityâ€¦");

  try {
    const r = await fetch(`${API}/api/refresh?${urlParam()}`, { method: "POST" });
    dbg("â† " + r.status);
    if (!r.ok) { const d = await r.json().catch(()=>({})); throw new Error(d.error || "Error " + r.status); }
    await pollRefresh();
  } catch(e) {
    dbg("âœ— " + e.message);
    setError(e.message);
    refreshing = false; setBusy(false);
    if (cta) { cta.disabled = false; document.getElementById("cta-ic").className = ""; }
  }
}

async function pollRefresh() {
  const cta = document.getElementById("cta-btn");
  for (let i = 0; i < 150; i++) {
    await sleep(2000);
    try {
      const r = await fetch(`${API}/api/refresh-status?${urlParam()}`);
      if (!r.ok) continue;
      const d = await r.json();
      dbg("[poll] " + d.status + " " + (d.progress||d.error||""));

      if (d.status === "running") { setStatus(d.progress || "Descargandoâ€¦"); continue; }
      if (d.status === "error")   { throw new Error(d.error || "Error durante la descarga"); }
      if (d.status === "done") {
        allFilms = d.films || [];
        showLastUpdate(d.ts, false);
        setStatus(null);
        clearDbg();
        populateGenres();
        renderGrid();
        updateCount();

        refreshing = false; setBusy(false);
        if (cta) { cta.disabled = false; const ci = document.getElementById("cta-ic"); if(ci) ci.className = ""; }
        return;
      }
    } catch(e) { if (e.message.includes("Error")) throw e; }
  }
  throw new Error("Timeout: la descarga tardÃ³ demasiado.");
}

// â”€â”€ Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGrid() {
  const wrap = document.getElementById("grid-wrap");
  const vis  = visible();
  if (allFilms.length === 0) { showEmptyState(); return; }
  if (vis.length === 0) {
    wrap.innerHTML = `<div class="cmsg"><div style="font-size:32px;margin-bottom:10px">ğŸ”</div><p>NingÃºn tÃ­tulo coincide con los filtros</p></div>`;
    updateCount(); return;
  }
  wrap.innerHTML = `<div class="grid">${vis.map((f,i) => cardHTML(f,i)).join("")}</div>`;
  updateCount();
}

function cardHTML(f, i) {
  const id    = f.id || f.title;
  const isDel = deletedIds.has(id);
  const tb    = f.type ? `<div class="tbadge ${f.type==="series"?"tseries":"tmovie"}">${f.type==="series"?"SERIE":"FILM"}</div>` : "";
  const rb    = f.rating ? `<div class="rbadge">â˜… ${f.rating}</div>` : "";
  const dov   = isDel ? `<div class="delover"><span class="dellabel">BORRAR</span></div>` : "";
  const img   = f.poster
    ? `<img src="${esc(f.poster)}" alt="${esc(f.title)}" loading="lazy" onerror="this.style.display='none'">`
    : `<div class="pph">ğŸ¬</div>`;
  const meta  = [f.year, f.duration ? (f.type==="series" ? f.duration+"m/ep" : f.duration+"min") : null].filter(Boolean).join(" Â· ");
  return `<div class="card${isDel?" deleted":""}" id="card-${f.id}" onclick="openModal('${f.id}')" style="animation-delay:${i*.02}s">
    <div class="pwrap">${img}<div class="grad"></div>${tb}${rb}${dov}
      <button class="delbtn${isDel?" on":""}" onclick="event.stopPropagation();toggleDel('${id}')" title="${isDel?"Quitar":"Marcar para borrar"}">âœ•</button>
    </div>
    <div class="cinfo">
      <div class="ctitle">${esc(f.title||"Sin tÃ­tulo")}</div>
      <div class="cmeta">${meta}</div>
    </div>
  </div>`;
}

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleDel(id) {
  if (deletedIds.has(id)) deletedIds.delete(id); else deletedIds.add(id);
  renderGrid(); syncMarks();
}
async function toggleDelModal() {
  if (!modalId) return;
  await toggleDel(modalId); updateModalDelBtn(modalId);
}
function updateModalDelBtn(id) {
  const btn = document.getElementById("mdelbtn"); if (!btn) return;
  const on = deletedIds.has(id);
  btn.className = "mdelbtn" + (on?" on":"");
  btn.textContent = on ? "âœ• Quitar marca" : "âœ• Marcar para borrar";
}
async function syncMarks() {
  try {
    await fetch(`${API}/api/marks/${listKey()}`, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ marks: [...deletedIds] }),
    });
  } catch {}
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(filmId) {
  const film = allFilms.find(f => f.id === filmId); if (!film) return;
  modalId = filmId; fillModal(film);
  document.getElementById("overlay").style.display = "flex";
  document.body.style.overflow = "hidden";
  document.addEventListener("keydown", onEsc);
}
function fillModal(film) {
  const faUrl = film.filmaffinity_url || `https://www.filmaffinity.com/es/film${film.id}.html`;
  document.getElementById("mposter").innerHTML = film.poster
    ? `<img src="${esc(film.poster)}" alt="${esc(film.title)}" onerror="this.parentElement.innerHTML='<div class=mpostph>ğŸ¬</div>'">`
    : `<div class="mpostph">ğŸ¬</div>`;
  const b = [];
  if (film.type)   b.push(`<span class="mbadge ${film.type==="series"?"mbseries":"mbmovie"}">${film.type==="series"?"ğŸ“º SERIE":"ğŸ¬ PELÃCULA"}</span>`);
  if (film.rating) b.push(`<span class="mbadge mbrating">â˜… ${film.rating}</span>`);
  document.getElementById("mbadges").innerHTML = b.join("");
  document.getElementById("mtitle").textContent = film.title || "Sin tÃ­tulo";
  const meta = [];
  if (film.year)     meta.push("ğŸ“… " + film.year);
  if (film.duration) meta.push("â± " + (film.type==="series" ? film.duration+" min/ep" : film.duration+" min"));
  document.getElementById("mmeta").innerHTML = meta.join(" &nbsp;Â·&nbsp; ");
  const gEl = document.getElementById("mgenres");
  gEl.innerHTML = (film.genres || []).map(g =>
    `<span style="font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,255,255,.07);border:1px solid var(--border);color:var(--text2);cursor:pointer" onclick="closeModal();onGenreFilter('${esc(g)}');document.getElementById('genre-filter').value='${esc(g)}';">${esc(g)}</span>`
  ).join("");
  const se = document.getElementById("msynopsis");
  se.className = film.synopsis ? "msynopsis" : "msynnone";
  se.textContent = film.synopsis || (film._enriched ? "Sin sinopsis disponible" : "Cargando sinopsisâ€¦");
  document.getElementById("falink").href = faUrl;
  updateModalDelBtn(film.id);
  document.getElementById("tmdb-note").textContent = film._enriched && film.synopsis ? "Sinopsis vÃ­a The Movie Database" : "";
}
function closeModal() {
  document.getElementById("overlay").style.display = "none";
  document.body.style.overflow = ""; modalId = null;
  document.removeEventListener("keydown", onEsc);
}
function onEsc(e) { if (e.key === "Escape") closeModal(); }

// â”€â”€ Controles UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f) {
  filter = f;
  document.querySelectorAll(".fbtn").forEach(b => b.classList.toggle("on", b.dataset.f === f));
  renderGrid();
}
function onSearch(v)      { searchQ  = v;              renderGrid(); }
function onRatingFilter(v){ minRating = parseFloat(v)||0; renderGrid(); }
function onGenreFilter(v) { genreFilter = v;            renderGrid(); }

function populateGenres() {
  const all = new Set();
  for (const f of allFilms) for (const g of (f.genres || [])) all.add(g);
  const sorted = [...all].sort((a,b) => a.localeCompare(b, "es"));
  const sel = document.getElementById("genre-filter");
  const cur = sel.value;
  sel.innerHTML = `<option value="">GÃ©nero</option>` +
    sorted.map(g => `<option value="${esc(g)}"${g===cur?" selected":""}>${esc(g)}</option>`).join("");
}
function toggleHideDel() {
  if (onlyDel) { onlyDel = false; document.getElementById("only-del-btn").classList.remove("on"); }
  hideDel = !hideDel;
  document.getElementById("hide-del-btn").classList.toggle("on", hideDel);
  renderGrid();
}
function toggleOnlyDel() {
  if (hideDel) { hideDel = false; document.getElementById("hide-del-btn").classList.remove("on"); }
  onlyDel = !onlyDel;
  document.getElementById("only-del-btn").classList.toggle("on", onlyDel);
  renderGrid();
}
function toggleDark() {
  dark = !dark;
  document.body.classList.toggle("light", !dark);
  document.getElementById("dark-ic").textContent = dark ? "â˜€" : "â˜¾";
}

// â”€â”€ Debug â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dbg(msg) {
  console.log(msg);
  let b = document.getElementById("dbg");
  if (!b) { b = document.createElement("div"); b.id = "dbg"; document.body.appendChild(b); }
  b.innerHTML += `<div>${new Date().toLocaleTimeString()} ${msg}</div>`;
  b.scrollTop = b.scrollHeight;
}
function clearDbg() { const b = document.getElementById("dbg"); if (b) b.remove(); }

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("xbtn").addEventListener("click", closeModal);
document.getElementById("overlay").addEventListener("click", function(e) { if (e.target === this) closeModal(); });
init();
</script>
</body>
</html>
