<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FA Viewer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,700;9..40,800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0c0e14;
      --card: #13161f;
      --modal: #161a26;
      --border: #252a38;
      --border-h: #3d4560;
      --text: #e4e8f4;
      --text2: #b0b8cc;
      --muted: #5a6380;
      --poster: #1a1e2e;
      --btn: #1e2233;
      --shadow: rgba(0,0,0,.45);
      --shadowh: rgba(0,0,0,.65);
      --header: rgba(12,14,20,.94);
      --accent: #e8a000;
    }
    .light {
      --bg: #eef0f7; --card: #fff; --modal: #fff;
      --border: #dde2ee; --border-h: #a0adcc;
      --text: #18202e; --text2: #4a5568; --muted: #8896b0;
      --poster: #dde2ee; --btn: #e8ecf5;
      --shadow: rgba(0,0,0,.07); --shadowh: rgba(0,0,0,.16);
      --header: rgba(238,240,247,.94); --accent: #c78a00;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; transition: background .3s, color .3s; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(28px); } to { opacity: 1; transform: translateY(0); } }
    ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      position: sticky; top: 0; z-index: 200;
      background: var(--header); backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      max-width: 1440px; margin: 0 auto; padding: 0 24px;
      height: 62px; display: flex; align-items: center; gap: 14px;
    }
    .logo { font-family: 'Playfair Display', serif; font-size: 18px; flex-shrink: 0; }
    .logo span { color: var(--accent); }
    .logo small { display: block; font-family: 'DM Sans', sans-serif; font-size: 9px; color: var(--muted); margin-top: 1px; }
    .filter-group { display: flex; gap: 4px; background: var(--btn); border-radius: 8px; padding: 3px; flex-shrink: 0; }
    .filter-btn {
      background: transparent; border: none; color: var(--muted);
      padding: 5px 12px; border-radius: 6px; cursor: pointer;
      font-size: 12px; font-weight: 700; font-family: inherit;
      transition: all .15s;
    }
    .filter-btn.active { background: var(--accent); color: #000; }
    .spacer { flex: 1; }
    .count { font-size: 12px; color: var(--muted); flex-shrink: 0; white-space: nowrap; }
    .count .deleted-count { color: #ef4444; }
    .icon-btn {
      background: var(--btn); border: 1px solid var(--border);
      color: var(--text); padding: 7px 14px; border-radius: 9px;
      cursor: pointer; font-size: 12px; font-weight: 700;
      font-family: inherit; display: flex; align-items: center; gap: 6px;
      flex-shrink: 0; transition: background .15s;
    }
    .icon-btn:hover { background: var(--border); }
    .icon-btn:disabled { opacity: .5; cursor: not-allowed; }
    .spin { display: inline-block; animation: spin .8s linear infinite; }
    .progress-bar { height: 3px; background: var(--border); }
    .progress-fill { height: 100%; background: var(--accent); transition: width .3s ease; }

    /* â”€â”€ MAIN â”€â”€ */
    main { max-width: 1440px; margin: 0 auto; padding: 24px 24px 60px; }

    /* â”€â”€ STATUS â”€â”€ */
    .status-box {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 16px; margin-bottom: 16px;
      background: var(--btn); border-radius: 10px;
      border: 1px solid var(--border); animation: fadeUp .3s ease;
    }
    .status-spinner { width: 14px; height: 14px; border-radius: 50%; border: 2px solid var(--border); border-top-color: var(--accent); animation: spin .8s linear infinite; flex-shrink: 0; }
    .status-text { font-size: 12px; color: var(--muted); }
    .status-right { margin-left: auto; font-size: 11px; color: var(--muted); }
    .error-box {
      padding: 20px 24px; margin-bottom: 16px;
      background: rgba(127,29,29,.2); border-radius: 12px;
      border: 1px solid rgba(239,68,68,.3);
    }
    .error-title { font-weight: 700; color: #f87171; margin-bottom: 8px; }
    .error-msg { font-size: 13px; color: #fca5a5; line-height: 1.6; }
    .retry-btn {
      margin-top: 12px; background: #7f1d1d; color: #fff;
      border: none; padding: 8px 18px; border-radius: 8px;
      cursor: pointer; font-size: 12px; font-weight: 700; font-family: inherit;
    }

    /* â”€â”€ GRID â”€â”€ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }

    /* â”€â”€ CARD â”€â”€ */
    .card {
      background: var(--card); border-radius: 14px; overflow: hidden;
      cursor: pointer; border: 1px solid var(--border);
      transition: transform .2s cubic-bezier(.16,1,.3,1), box-shadow .2s, border-color .2s, opacity .2s;
      box-shadow: 0 2px 8px var(--shadow);
      animation: fadeUp .4s ease both;
    }
    .card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 20px 48px var(--shadowh); border-color: var(--border-h); }
    .card.deleted { opacity: .38; border-color: rgba(239,68,68,.4); }
    .poster-wrap { position: relative; padding-top: 148%; background: var(--poster); overflow: hidden; }
    .poster-wrap img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transition: transform .3s ease; }
    .card:hover .poster-wrap img { transform: scale(1.06); }
    .poster-placeholder { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 36px; color: var(--muted); }
    .grad { position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(to top, rgba(0,0,0,.8) 0%, transparent 100%); }
    .type-badge {
      position: absolute; top: 8px; left: 8px;
      color: #fff; font-size: 8px; font-weight: 900;
      padding: 3px 7px; border-radius: 20px; letter-spacing: .12em;
      text-transform: uppercase; backdrop-filter: blur(4px);
    }
    .type-movie { background: rgba(185,28,28,.85); }
    .type-series { background: rgba(109,40,217,.85); }
    .rating-badge { position: absolute; bottom: 36px; left: 10px; color: #fbbf24; font-size: 13px; font-weight: 800; text-shadow: 0 1px 4px rgba(0,0,0,.8); }
    .del-btn {
      position: absolute; top: 8px; right: 8px; z-index: 10;
      width: 26px; height: 26px;
      background: rgba(0,0,0,.6); border: 1px solid rgba(255,255,255,.15);
      backdrop-filter: blur(4px); border-radius: 50%;
      color: #fff; font-size: 13px; font-weight: 900;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; opacity: 0; transition: all .15s; line-height: 1;
    }
    .card:hover .del-btn, .card.deleted .del-btn { opacity: 1; }
    .del-btn.active { background: rgba(239,68,68,.9); border-color: #ef4444; opacity: 1; }
    .del-overlay {
      position: absolute; inset: 0; background: rgba(239,68,68,.12);
      display: flex; align-items: center; justify-content: center;
    }
    .del-label { background: rgba(239,68,68,.9); color: #fff; font-weight: 900; font-size: 10px; letter-spacing: .15em; padding: 5px 12px; border-radius: 4px; transform: rotate(-8deg); text-transform: uppercase; }
    .card-info { padding: 10px 12px 12px; }
    .card-title { font-size: 12px; font-weight: 600; color: var(--text); line-height: 1.35; font-family: 'Playfair Display', serif; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 3px; }
    .card-meta { font-size: 10px; color: var(--muted); }

    /* â”€â”€ EMPTY / LOADING â”€â”€ */
    .center-msg { text-align: center; padding: 100px 20px; }
    .big-spinner { width: 52px; height: 52px; border-radius: 50%; border: 3px solid var(--border); border-top-color: var(--accent); animation: spin .9s linear infinite; margin: 0 auto 20px; }
    .center-msg p { color: var(--muted); font-size: 14px; margin-top: 8px; }
    .center-icon { font-size: 36px; margin-bottom: 12px; }

    /* â”€â”€ MODAL â”€â”€ */
    .overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,.88); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      padding: 20px; animation: fadeUp .2s ease;
    }
    .modal {
      background: var(--modal); border-radius: 20px;
      max-width: 700px; width: 100%; max-height: 88vh; overflow-y: auto;
      border: 1px solid var(--border); box-shadow: 0 40px 100px rgba(0,0,0,.7);
      animation: slideUp .25s cubic-bezier(.16,1,.3,1); position: relative;
    }
    .modal-inner { display: flex; }
    .modal-poster { width: 200px; flex-shrink: 0; border-radius: 20px 0 0 20px; overflow: hidden; background: var(--poster); min-height: 280px; display: flex; align-items: stretch; }
    .modal-poster img { width: 100%; object-fit: cover; display: block; }
    .modal-poster-ph { display: flex; align-items: center; justify-content: center; width: 100%; font-size: 60px; color: var(--muted); }
    .modal-info { flex: 1; padding: 28px 52px 28px 24px; min-width: 0; }
    .badges { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
    .badge { font-size: 10px; font-weight: 800; padding: 3px 10px; border-radius: 20px; letter-spacing: .1em; text-transform: uppercase; }
    .badge-series { background: rgba(124,58,237,.2); color: #a78bfa; border: 1px solid rgba(124,58,237,.4); }
    .badge-movie { background: rgba(194,65,12,.2); color: #fb923c; border: 1px solid rgba(194,65,12,.4); }
    .badge-rating { background: rgba(232,160,0,.15); color: var(--accent); border: 1px solid rgba(232,160,0,.3); }
    .modal-title { font-size: 20px; line-height: 1.3; font-family: 'Playfair Display', serif; color: var(--text); margin-bottom: 6px; }
    .modal-meta { font-size: 13px; color: var(--muted); margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
    .modal-synopsis { line-height: 1.75; color: var(--text2); font-size: 13px; margin-bottom: 20px; }
    .modal-synopsis-none { color: var(--muted); font-size: 13px; font-style: italic; margin-bottom: 20px; }
    .fa-link {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--accent); color: #000;
      padding: 10px 22px; border-radius: 10px;
      text-decoration: none; font-weight: 700; font-size: 13px;
      transition: opacity .15s;
    }
    .fa-link:hover { opacity: .85; }
    .close-btn {
      position: absolute; top: 14px; right: 14px;
      background: var(--btn); border: 1px solid var(--border);
      color: var(--text); width: 34px; height: 34px;
      border-radius: 50%; cursor: pointer; font-size: 18px;
      display: flex; align-items: center; justify-content: center;
      line-height: 1; font-family: inherit;
    }
    .hide-deleted-btn {
      background: var(--btn); border: 1px solid var(--border);
      color: var(--muted); padding: 7px 12px; border-radius: 9px;
      cursor: pointer; font-size: 11px; font-weight: 700;
      font-family: inherit; flex-shrink: 0; transition: all .15s;
    }
    .hide-deleted-btn.active { background: rgba(239,68,68,.15); color: #f87171; border-color: rgba(239,68,68,.3); }

    @media (max-width: 600px) {
      .modal-inner { flex-direction: column; }
      .modal-poster { width: 100%; border-radius: 20px 20px 0 0; min-height: 240px; }
      .header-inner { gap: 8px; padding: 0 12px; }
      .count { display: none; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">
      <span>FA</span> Viewer
      <small id="last-update"></small>
    </div>

    <div class="filter-group">
      <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">Todo</button>
      <button class="filter-btn" data-filter="movies" onclick="setFilter('movies')">ğŸ¬</button>
      <button class="filter-btn" data-filter="series" onclick="setFilter('series')">ğŸ“º</button>
    </div>

    <button class="hide-deleted-btn" id="hide-btn" onclick="toggleShowDeleted()">ğŸ‘ Mostrar todos</button>

    <div class="spacer"></div>
    <div class="count" id="count-label"></div>

    <button class="icon-btn" id="refresh-btn" onclick="loadList(true)">
      <span id="refresh-icon">â†º</span> Actualizar
    </button>
    <button class="icon-btn" onclick="toggleDark()">
      <span id="dark-icon">â˜€</span>
    </button>
  </div>
  <div class="progress-bar">
    <div class="progress-fill" id="progress-fill" style="width:0%"></div>
  </div>
</header>

<main>
  <div id="status-area"></div>
  <div id="grid" class="grid"></div>
  <div id="empty-msg" class="center-msg" style="display:none">
    <div class="center-icon">ğŸ¬</div>
    <p>No hay tÃ­tulos que mostrar</p>
  </div>
</main>

<!-- Modal -->
<div class="overlay" id="overlay" style="display:none" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <button class="close-btn" onclick="closeModal()">âœ•</button>
    <div class="modal-inner">
      <div class="modal-poster" id="modal-poster"></div>
      <div class="modal-info">
        <div class="badges" id="modal-badges"></div>
        <h2 class="modal-title" id="modal-title"></h2>
        <div class="modal-meta" id="modal-meta"></div>
        <p id="modal-synopsis"></p>
        <a class="fa-link" id="modal-link" href="#" target="_blank" rel="noopener">Ver en FilmAffinity â†—</a>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_URL = "https://www.filmaffinity.com/es/userlist.php?user_id=629775&list_id=1013";
// Backend URL: same origin in production, or set via env
const API = window.FA_API_URL || "";

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allFilms = [];
let deletedIds = new Set();
let filter = "all";
let showDeleted = true;
let dark = true;
let loading = false;
let loadingDetails = false;
let detailDone = 0;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getListUrl() {
  try {
    const p = new URLSearchParams(location.search);
    const b64 = p.get("url");
    if (b64) return atob(b64);
  } catch {}
  return DEFAULT_URL;
}

function listKey() {
  return "fa_" + btoa(getListUrl()).replace(/[^a-z0-9]/gi, "").slice(0, 20);
}

function setStatus(msg, done, total) {
  const el = document.getElementById("status-area");
  if (!msg) { el.innerHTML = ""; return; }
  const pct = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById("progress-fill").style.width = (total > 0 ? pct : 30) + "%";
  el.innerHTML = `<div class="status-box">
    <div class="status-spinner"></div>
    <span class="status-text">${msg}</span>
    ${total > 0 ? `<span class="status-right">${done}/${total}</span>` : ""}
  </div>`;
}

function setError(msg) {
  document.getElementById("progress-fill").style.width = "0%";
  document.getElementById("status-area").innerHTML = msg ? `
    <div class="error-box">
      <div class="error-title">âš  Error</div>
      <div class="error-msg">${msg}</div>
      <button class="retry-btn" onclick="loadList(true)">Reintentar</button>
    </div>` : "";
}

function updateCount() {
  const vis = visibleFilms();
  const del = deletedIds.size;
  document.getElementById("count-label").innerHTML =
    `${vis.length} de ${allFilms.length} tÃ­tulos` +
    (del > 0 ? ` <span class="deleted-count">Â· ${del} marcados</span>` : "");
}

function visibleFilms() {
  return allFilms.filter(f => {
    if (!showDeleted && deletedIds.has(f.id || f.title)) return false;
    if (filter === "movies") return f.type !== "series";
    if (filter === "series") return f.type === "series";
    return true;
  });
}

// â”€â”€ Load list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadList(force = false) {
  if (loading) return;
  loading = true;
  setError(null);
  toggleRefreshBtn(true);

  const url = getListUrl();
  const apiUrl = `${API}/api/list?url=${encodeURIComponent(btoa(url))}${force ? "&force=1" : ""}`;

  setStatus("Obteniendo lista de FilmAffinity...");
  renderGrid([]);

  try {
    const r = await fetch(apiUrl);
    const data = await r.json();
    if (!r.ok) throw new Error(data.error || "Error desconocido");

    allFilms = data.films || [];
    document.getElementById("last-update").textContent = new Date().toLocaleTimeString("es-ES");
    setStatus(null);
    renderGrid(allFilms);
    updateCount();
    loading = false;
    toggleRefreshBtn(false);

    // Load details progressively
    await loadDetails();

  } catch (err) {
    setError(err.message);
    loading = false;
    toggleRefreshBtn(false);
  }
}

async function loadDetails() {
  loadingDetails = true;
  detailDone = 0;
  const total = allFilms.length;

  for (let i = 0; i < allFilms.length; i++) {
    const film = allFilms[i];
    if (film._detailed) { detailDone++; continue; }
    setStatus(`Cargando detalles: ${film.title || film.id}`, i + 1, total);
    try {
      const r = await fetch(`${API}/api/film/${film.id}`);
      if (r.ok) {
        const details = await r.json();
        allFilms[i] = { ...film, ...details, _detailed: true };
        updateCard(allFilms[i]);
      }
    } catch {}
    detailDone++;
    document.getElementById("progress-fill").style.width = Math.round((i + 1) / total * 100) + "%";
    await sleep(250);
  }

  setStatus(null);
  document.getElementById("progress-fill").style.width = "0%";
  loadingDetails = false;
  updateCount();

  // Cache to localStorage
  try {
    localStorage.setItem(listKey() + "_data", JSON.stringify(allFilms));
    localStorage.setItem(listKey() + "_ts", String(Date.now()));
  } catch {}
}

// â”€â”€ Grid rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGrid(films) {
  const grid = document.getElementById("grid");
  const empty = document.getElementById("empty-msg");
  const visible = films.filter(f => {
    if (!showDeleted && deletedIds.has(f.id || f.title)) return false;
    if (filter === "movies") return f.type !== "series";
    if (filter === "series") return f.type === "series";
    return true;
  });

  if (films.length === 0 && !loading) {
    grid.innerHTML = `<div class="center-msg"><div class="big-spinner"></div><p>Cargando...</p></div>`;
    empty.style.display = "none";
    return;
  }

  if (visible.length === 0) {
    grid.innerHTML = "";
    empty.style.display = "block";
    return;
  }

  empty.style.display = "none";
  grid.innerHTML = visible.map((f, i) => cardHTML(f, i)).join("");
  updateCount();
}

function cardHTML(f, i) {
  const id = f.id || f.title;
  const isDel = deletedIds.has(id);
  const typeBadge = f.type ? `<div class="type-badge ${f.type === 'series' ? 'type-series' : 'type-movie'}">${f.type === 'series' ? 'SERIE' : 'FILM'}</div>` : "";
  const ratingBadge = f.rating ? `<div class="rating-badge">â˜… ${f.rating}</div>` : "";
  const delOverlay = isDel ? `<div class="del-overlay"><span class="del-label">BORRAR</span></div>` : "";
  const posterContent = f.poster
    ? `<img src="${f.poster}" alt="${esc(f.title)}" loading="lazy" onerror="this.style.display='none'">`
    : `<div class="poster-placeholder">ğŸ¬</div>`;
  const meta = [f.year, f.duration ? (f.type === "series" ? f.duration + "m/ep" : f.duration + "min") : null].filter(Boolean).join(" Â· ");

  return `<div class="card${isDel ? " deleted" : ""}" id="card-${f.id}" onclick="openModal('${f.id}')" style="animation-delay:${i * 0.025}s">
    <div class="poster-wrap">
      ${posterContent}
      <div class="grad"></div>
      ${typeBadge}
      ${ratingBadge}
      ${delOverlay}
      <button class="del-btn${isDel ? ' active' : ''}" onclick="event.stopPropagation();toggleDelete('${id}')" title="${isDel ? 'Quitar marca' : 'Marcar para borrar'}">âœ•</button>
    </div>
    <div class="card-info">
      <div class="card-title">${esc(f.title || "Sin tÃ­tulo")}</div>
      <div class="card-meta">${meta}</div>
    </div>
  </div>`;
}

function updateCard(film) {
  const el = document.getElementById("card-" + film.id);
  if (!el) return;
  const idx = visibleFilms().findIndex(f => f.id === film.id);
  if (idx >= 0) {
    el.outerHTML = cardHTML(film, idx);
  }
}

// â”€â”€ Delete marks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleDelete(id) {
  if (deletedIds.has(id)) deletedIds.delete(id); else deletedIds.add(id);
  renderGrid(allFilms);
  // Sync to server
  try {
    await fetch(`${API}/api/marks/${listKey()}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ marks: [...deletedIds] }),
    });
  } catch {}
}

async function loadDeletedMarks() {
  try {
    const r = await fetch(`${API}/api/marks/${listKey()}`);
    const data = await r.json();
    deletedIds = new Set(data.marks || []);
  } catch {}
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(filmId) {
  const film = allFilms.find(f => f.id === filmId);
  if (!film) return;

  const faUrl = film.filmaffinity_url || `https://www.filmaffinity.com/es/film${filmId}.html`;

  // Poster
  const poster = document.getElementById("modal-poster");
  poster.innerHTML = film.poster
    ? `<img src="${film.poster}" alt="${esc(film.title)}" onerror="this.parentElement.innerHTML='<div class=modal-poster-ph>ğŸ¬</div>'">`
    : `<div class="modal-poster-ph">ğŸ¬</div>`;

  // Badges
  const badges = [];
  if (film.type) badges.push(`<span class="badge ${film.type === 'series' ? 'badge-series' : 'badge-movie'}">${film.type === 'series' ? 'ğŸ“º SERIE' : 'ğŸ¬ PELÃCULA'}</span>`);
  if (film.rating) badges.push(`<span class="badge badge-rating">â˜… ${film.rating}</span>`);
  document.getElementById("modal-badges").innerHTML = badges.join("");

  document.getElementById("modal-title").textContent = film.title || "Sin tÃ­tulo";

  const meta = [];
  if (film.year) meta.push("ğŸ“… " + film.year);
  if (film.duration) meta.push("â± " + (film.type === "series" ? film.duration + " min/ep" : film.duration + " min"));
  document.getElementById("modal-meta").innerHTML = meta.join(" Â· ");

  const synEl = document.getElementById("modal-synopsis");
  synEl.className = film.synopsis ? "modal-synopsis" : "modal-synopsis-none";
  synEl.textContent = film.synopsis || "Sin sinopsis disponible";

  document.getElementById("modal-link").href = faUrl;
  document.getElementById("overlay").style.display = "flex";
  document.addEventListener("keydown", onEsc);
}

function closeModal(e) {
  if (e && e.target !== document.getElementById("overlay") && e.type !== "click") return;
  if (e && e.currentTarget === document.getElementById("overlay") && e.target !== e.currentTarget) return;
  document.getElementById("overlay").style.display = "none";
  document.removeEventListener("keydown", onEsc);
}

function onEsc(e) { if (e.key === "Escape") closeModal({}); }

// â”€â”€ UI Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f) {
  filter = f;
  document.querySelectorAll(".filter-btn").forEach(b => b.classList.toggle("active", b.dataset.filter === f));
  renderGrid(allFilms);
}

function toggleShowDeleted() {
  showDeleted = !showDeleted;
  const btn = document.getElementById("hide-btn");
  btn.classList.toggle("active", !showDeleted);
  btn.textContent = showDeleted ? "ğŸ‘ Mostrar todos" : "ğŸ™ˆ Ocultar marcados";
  renderGrid(allFilms);
}

function toggleDark() {
  dark = !dark;
  document.body.classList.toggle("light", !dark);
  document.getElementById("dark-icon").textContent = dark ? "â˜€" : "â˜¾";
}

function toggleRefreshBtn(busy) {
  const btn = document.getElementById("refresh-btn");
  const icon = document.getElementById("refresh-icon");
  btn.disabled = busy;
  icon.className = busy ? "spin" : "";
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return (s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  await loadDeletedMarks();
  await loadList(false);
  setInterval(() => loadList(false), 30 * 60 * 1000);
})();

// Close modal clicking overlay
document.getElementById("overlay").addEventListener("click", function(e) {
  if (e.target === this) closeModal({});
});
</script>
</body>
</html>
